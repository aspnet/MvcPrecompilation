<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildThisFileDirectory)..\common.targets" />
  <PropertyGroup>
    <MvcRazorRunCommand Condition="'$(MvcRazorRunCommand)'==''">$(OutputPath)$(MSBuildThisFileName).exe</MvcRazorRunCommand>
  </PropertyGroup>

  <Target
      Name="MvcRazorPrecompile"
      DependsOnTargets="_ResolveInputArguments"
      Inputs="$(MSBuildThisFileFullPath);@(MvcRazorFilesToCompile);@(IntermediateAssembly);@(DocFileItem);@(_DebugSymbolsIntermediatePath);@(ReferencePath);$(MSBuildAllProjects);"
      Outputs="$(_MvcRazorOutputFullPath)">

    <CallTarget Targets="_CreateResponseFileForMvcRazorPrecompile" />

    <ItemGroup>
      <FilesToCopy Include="$(OutputPath)$(AssemblyName).exe.config">
        <Destination>$(OutputPath)$(MSBuildThisFileName).exe.config</Destination>
      </FilesToCopy>
      <FilesToCopy Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).exe">
        <Destination>$(MvcRazorRunCommand)</Destination>
      </FilesToCopy>
    </ItemGroup>

    <Copy
      SourceFiles="@(FilesToCopy)"
      DestinationFiles="%(Destination)" />

    <Message
      Text="Executing Razor view precompilation."
      Importance="Low" />

    <Exec
      Command="$(MvcRazorRunCommand) @&quot;$(_MvcRazorResponseFilePath)&quot;"
      WorkingDirectory="$(MSBuildProjectDirectory)"/>

    <Message
      Text="Razor view compilation for $(MSBuildProjectName) -> $(_MvcRazorOutputFullPath)"
      Importance="High" />

    <Delete Files="%(FilesToCopy.Destination)" />

  </Target>
</Project>